<!-- Start Breadcrumbs -->
<app-breadcrumbs
  title="BASE MEDICALE"
  [breadcrumbItems]="breadCrumbItems"
></app-breadcrumbs>
<!-- End Breadcrumbs -->

<div class="col-lg-12">
  <div class="card">
    <div class="card-header">
      <div class="row g-4 align-items-center">
        <div class="col-md-7 col-xl-4">
          <div class="hstack gap-2">
            <app-input
              label="Rechercher"
              placeholder="Rechercher (nom et/ou prénoms)"
              [control]="searchControl"
              bottomMargin="0"
            >
            </app-input>
          </div>
        </div>

        <div class="d-flex col-md-5 col-xl-8">
          <div class="ms-auto">
            <div
              class="form-check form-check-inline form-radio-outline form-radio-secondary"
            >
              <input
                class="form-check-input"
                type="radio"
                name="waitingListRadio"
                id="me"
                value="me"
                checked
                [formControl]="filterRadioControl"
              />
              <label class="form-check-label" for="me">
                Ma liste d'attente
              </label>
            </div>

            <div
              class="form-check form-check-inline form-radio-outline form-radio-secondary"
            >
              <input
                class="form-check-input"
                type="radio"
                name="waitingListRadio"
                id="sector"
                value="sector"
                [formControl]="filterRadioControl"
              />
              <label class="form-check-label" for="sector">
                Liste d'attente de mon secteur
              </label>
            </div>

            <div
              class="form-check form-check-inline form-radio-outline form-radio-secondary"
            >
              <input
                class="form-check-input"
                type="radio"
                name="waitingListRadio"
                id="all"
                value="all"
                [formControl]="filterRadioControl"
              />
              <label class="form-check-label" for="all">
                Toute la liste d'attente
              </label>
            </div>

            <div
              class="form-check form-check-inline form-radio-outline form-radio-secondary"
            >
              <input
                class="form-check-input"
                type="radio"
                name="waitingListRadio"
                id="doctor"
                value="doctor"
                [formControl]="filterRadioControl"
              />
              <label class="form-check-label" for="doctor">
                Liste d'attente par médecin
              </label>
            </div>

            <div *ngIf="filterRadioControl.value === 'doctor'">
              <app-select
                [isMandatory]="true"
                label=""
                [options]="doctors"
                [control]="doctorControl"
              ></app-select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card-body">
      <div class="row">
        <div class="col-12">
          <div class="table-responsive table-card">
            <table
              class="table table-one-liner table-hover table-bordered table-striped table-sm align-middle mb-0"
            >
              <thead class="table-light text-muted">
                <tr>
                  <th colspan="10" class="bg-white"></th>
                  <th colspan="2">Temps avant rafraîchissement:</th>
                  <th colspan="1">
                    <countdown
                      #countdown
                      [config]="{
                        leftTime: 120,
                        format: 'mm:ss',
                        demand: true
                      }"
                    ></countdown>
                  </th>
                  <th>
                    <button
                      type="button"
                      class="btn btn-outline-dark btn-icon waves-effect waves-light"
                      (click)="refreshWaitingList()"
                    >
                      <i class="mdi mdi-refresh fs-24"></i>
                      <!-- ri-refresh-line
                      mdi mdi-reload -->
                    </button>
                  </th>
                </tr>
                <tr>
                  <th scope="col">
                    {{ "Ordre" | uppercase }}
                  </th>
                  <th scope="col">
                    {{ "Référence" | uppercase }}
                  </th>
                  <th scope="col">{{ "Nom" | uppercase }}</th>
                  <th scope="col">
                    {{ "Prénom(s)" | uppercase }}
                  </th>
                  <th scope="col">
                    {{ "Né(e) le" | uppercase }}
                  </th>
                  <th scope="col">{{ "Âge" | uppercase }}</th>
                  <th scope="col">{{ "Sexe" | uppercase }}</th>
                  <th scope="col">
                    {{ "Prestations" | uppercase }}
                  </th>
                  <th scope="col">
                    {{ "Total facture" | uppercase }}
                  </th>
                  <th scope="col">
                    {{ "Secteur" | uppercase }}
                  </th>
                  <th scope="col">
                    {{ "Médecin" | uppercase }}
                  </th>
                  <th scope="col">
                    {{ "Date arrivée" | uppercase }}
                  </th>
                  <th scope="col">
                    {{ "Heure" | uppercase }}
                  </th>
                  <th scope="col"></th>
                </tr>
              </thead>

              <tbody>
                <tr
                  *ngFor="let item of waitingListCut"
                  class="user-select-none"
                  (dblclick)="goToPatientVisits(item)"
                >
                  <td>{{ item.num_attente }}</td>
                  <td>{{ item.patient.reference }}</td>
                  <!-- <td>{{ item.patient.nom | uppercase }}</td>
                  <td>{{ item.patient.prenoms }}</td> -->
                  <td>
                    <ngb-highlight
                      [result]="item.patient.nom"
                      [term]="searchControl.value.split(' ')[0]"
                    ></ngb-highlight>
                  </td>

                  <td>
                    <ngb-highlight
                      [result]="item.patient.prenoms"
                      [term]="[
                        searchControl.value.split(' ')[1],
                        searchControl.value
                      ]"
                    ></ngb-highlight>
                  </td>
                  <td>
                    {{ item.patient.date_naissance | date : "dd/MM/yyyy" }}
                  </td>
                  <td>{{ item.patient.age }}</td>
                  <td>{{ item.patient.sexe }}</td>
                  <td
                    style="
                      max-width: 100px;
                      overflow: hidden !important;
                      text-overflow: ellipsis !important;
                      white-space: nowrap !important;
                    "
                  >
                    <!-- <span
                      *ngFor="let prestation of item.facture.prestation.tarifs"
                    >
                      {{ prestation.libelle + " " }}
                    </span> -->

                    <ng-container
                      *ngFor="
                        let prestation of item.facture.prestation.tarifs
                          | slice : 0 : 5;
                        index as i;
                        count as c
                      "
                    >
                      <span>
                        {{ prestation.libelle }}
                      </span>
                      <span *ngIf="i < 4 && c !== i + 1"> <b>*</b> </span>
                      <span
                        *ngIf="
                          i == 4 && c < item.facture.prestation.tarifs.length
                        "
                        ><b> * ... </b></span
                      >
                    </ng-container>
                  </td>
                  <td>{{ item.facture.total | mask : "separator" }}</td>
                  <td>{{ item.secteur_code ? item.secteur?.libelle : "-" }}</td>
                  <td>
                    {{
                      item.medecin
                        ? item.medecin_consulteur?.nom +
                          " " +
                          item.medecin_consulteur?.prenoms
                        : "-"
                    }}
                  </td>
                  <td>{{ item.date_attente | date : "dd/MM/yyyy" }}</td>
                  <td>{{ item.date_attente | date : "HH:mm:ss" }}</td>

                  <td>
                    <div class="d-inline-block" ngbDropdown container="body">
                      <button
                        type="button"
                        class="btn btn-icon btn-outline-dark btn-sm waves-effect waves-light arrow-none"
                        ngbDropdownToggle
                      >
                        <i class="ri-more-fill fs-24"></i>
                      </button>
                      <div ngbDropdownMenu>
                        <button
                          ngbDropdownItem
                          (click)="openInvoiceDetailsModal(item.facture)"
                        >
                          <i
                            class="ri-information-line label-icon align-middle fs-16 me-2 text-success"
                          ></i>
                          Détails de la facture
                        </button>

                        <button
                          ngbDropdownItem
                          (click)="goToPatientVisits(item)"
                        >
                          <i
                            class="ri-arrow-right-line label-icon align-middle fs-16 me-2 text-secondary"
                          ></i>
                          Consulter
                        </button>
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="card-body">
      <div class="row">
        <div class="col-12">
          <div class="d-flex justify-content-between p-2">
            <ngb-pagination
              [collectionSize]="collectionSize"
              [(page)]="page"
              [pageSize]="pageSize"
              (pageChange)="refreshWaitingListTable()"
            >
            </ngb-pagination>

            <select
              class="form-select"
              style="width: auto"
              [(ngModel)]="pageSize"
              (ngModelChange)="refreshWaitingListTable()"
            >
              <option [ngValue]="10">10 éléments par page</option>
              <option [ngValue]="15">15 éléments par page</option>
              <option [ngValue]="20">20 éléments par page</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
